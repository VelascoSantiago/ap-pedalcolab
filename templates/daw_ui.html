<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAW - Interfaz de Control</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body id="daw-app"> <!-- Usamos tu ID -->
    <div class="container">
        <div class="panel tracks-panel"> <!-- Usamos tu clase .panel -->
            <div class="logo-container">
                <img src="{{ url_for('static', filename='images/logo.png') }}" 
                     alt="Logo de Pedalcolab" 
                     style="filter: invert(1); max-width: 120px;">
            </div>
            <h2>Librería de Pistas</h2>
            <h3>Pistas Crudas (Subidas)</h3>
            <ul id="raw-tracks-list" class="track-list"> <!-- Usamos tu clase .track-list -->
                <!-- Se llenará dinámicamente -->
            </ul>
            <h3>Pistas Procesadas (FX)</h3>
            <ul id="processed-tracks-list" class="track-list"> <!-- Usamos tu clase .track-list -->
                <!-- Se llenará dinámicamente -->
            </ul>
        </div>

        <div class="panel effects-panel"> <!-- Usamos tu clase .panel -->
            <h1>Panel de Efectos</h1>
            <form id="effects-form" method="post" action="">
                <div id="selected-track-display">Selecciona una pista cruda para procesar</div>
                <!-- Secciones de efectos -->
                <!-- SECCIÓN DE DISTORSIÓN -->
                <div class="effects-section">
                    <h2>Distorsión</h2>
                    <div class="effect-control">
                        <label for="dist-knob">Drive</label>
                        <div class="knob-container">
                            <div class="knob" id="dist-knob" data-effect="dist" data-value="0"></div>
                            <div class="knob-value" id="dist-value">0%</div>
                            <input type="hidden" id="dist-hidden-input" name="dist" value="0">
                        </div>
                    </div>
                    <div class="effect-control">
                        <label for="bitcrush-knob">Bitcrush</label>
                        <div class="knob-container">
                            <div class="knob" id="bitcrush-knob" data-effect="bitcrush" data-value="0"></div>
                            <div class="knob-value" id="bitcrush-value">0%</div>
                            <input type="hidden" id="bitcrush-hidden-input" name="bitcrush" value="0">
                        </div>
                    </div>
                    <div class="effect-control">
                        <label for="clipping-knob">Clipping</label>
                        <div class="knob-container">
                            <div class="knob" id="clipping-knob" data-effect="clipping" data-value="0"></div>
                            <div class="knob-value" id="clipping-value">0%</div>
                            <input type="hidden" id="clipping-hidden-input" name="clipping" value="0">
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN DE MODULACIÓN -->
                <div class="effects-section">
                    <h2>Modulación</h2>
                    <div class="effect-control">
                        <label for="chorus-knob">Chorus</label>
                        <div class="knob-container">
                            <div class="knob" id="chorus-knob" data-effect="chorus" data-value="0"></div>
                            <div class="knob-value" id="chorus-value">0%</div>
                            <input type="hidden" id="chorus-hidden-input" name="chorus" value="0">
                        </div>
                    </div>
                    <div class="effect-control">
                        <label for="phaser-knob">Phaser</label>
                        <div class="knob-container">
                            <div class="knob" id="phaser-knob" data-effect="phaser" data-value="0"></div>
                            <div class="knob-value" id="phaser-value">0%</div>
                            <input type="hidden" id="phaser-hidden-input" name="phaser" value="0">
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN DE TIEMPO Y ESPACIO -->
                <div class="effects-section">
                    <h2>Tiempo y Espacio</h2>
                    <div class="effect-control">
                        <label for="reverb-knob">Reverb</label>
                        <div class="knob-container">
                            <div class="knob" id="reverb-knob" data-effect="reverb" data-value="0"></div>
                            <div class="knob-value" id="reverb-value">0%</div>
                            <input type="hidden" id="reverb-hidden-input" name="reverb" value="0">
                        </div>
                    </div>
                    <div class="effect-control">
                        <label for="delay-knob">Delay</label>
                        <div class="knob-container">
                            <div class="knob" id="delay-knob" data-effect="delay" data-value="0"></div>
                            <div class="knob-value" id="delay-value">0%</div>
                            <input type="hidden" id="delay-hidden-input" name="delay" value="0">
                        </div>
                    </div>
                </div>
                
                <!-- SECCIÓN DE PITCH (Mantenemos Slider) -->
                <div class="effects-section">
                    <h2>Pitch</h2>
                    <div class="effect-control">
                        <label for="pitchshift">Pitch Shift (Semitonos)</label>
                        <!-- Usamos el ID original para no romper el CSS si lo tenías -->
                        <input type="range" id="pitchshift" name="pitchshift" min="-12" max="12" step="1" value="0"> 
                        <!-- Podrías añadir un display para el valor si quieres: <span id="pitchshift-value">0</span> -->
                    </div>
                </div>

                <!-- SECCIÓN DE DINÁMICA -->
                 <div class="effects-section">
                    <h2>Dinámica</h2>
                    <div class="effect-control">
                        <label for="comp-knob">Compresor</label>
                        <div class="knob-container">
                            <div class="knob" id="comp-knob" data-effect="comp" data-value="0"></div>
                            <div class="knob-value" id="comp-value">0%</div>
                            <input type="hidden" id="comp-hidden-input" name="comp" value="0">
                        </div>
                    </div>
                </div>
                
                <input type="submit" value="Procesar Pista" class="button"> <!-- Usamos tu clase .button -->
            </form>
        </div>
    </div>

    <script>
        const rawList = document.getElementById('raw-tracks-list');
        const processedList = document.getElementById('processed-tracks-list');
        let selectedTrackName = null;

        function selectTrack(filename) {
            selectedTrackName = filename;
            document.getElementById('effects-form').action = '/process/' + encodeURIComponent(filename);
            document.getElementById('selected-track-display').textContent = 'Procesando: ' + filename;
            updateSelection();
        }
        
        function updateSelection() {
            document.querySelectorAll('#raw-tracks-list li').forEach(item => {
                // Usamos dataset para guardar el nombre y comparar de forma segura
                item.classList.toggle('selected', item.dataset.trackName === selectedTrackName);
            });
        }

        async function fetchAndUpdateAllTracks() {
            try {
                const response = await fetch('/api/tracks'); // Usamos tu ruta API /api/tracks
                const data = await response.json();
                
                // Actualizar Pistas Crudas
                rawList.innerHTML = '';
                if (data.raw_tracks.length > 0) {
                    data.raw_tracks.forEach(track => {
                        // Creamos el HTML con tus clases .track-item y .selectable
                        rawList.innerHTML += `
                            <li class="track-item selectable" data-track-name="${track}" onclick="selectTrack('${track}')">
                                <div class="file-name">${track}</div>
                                <audio controls onclick="event.stopPropagation();"><source src="/download/raw/${track}"></audio>
                                <button class="delete-btn" onclick="deleteTrack('raw', '${track}', event)">&times;</button>
                            </li>`;
                        });
                    } else {
                    rawList.innerHTML = '<li class="track-item">Sube una pista desde el celular...</li>';
                }
                
                // Actualizar Pistas Procesadas
                processedList.innerHTML = '';
                if (data.processed_tracks.length > 0) {
                    data.processed_tracks.forEach(track => {
                        // Creamos el HTML con tu clase .track-item
                        processedList.innerHTML += `
                        <li class="track-item">
                            <div class="file-name">${track}</div>
                            <audio controls><source src="/download/fx/${track}"></audio>
                            <button class="delete-btn" onclick="deleteTrack('fx', '${track}', event)">&times;</button>
                            </li>`;
                        });
                } else {
                    processedList.innerHTML = '<li class="track-item">Ninguna pista procesada.</li>';
                }
                
                updateSelection(); // Re-aplicar la selección visual
            } catch (error) {
                console.error('Error al actualizar las pistas:', error);
            }
        }

        async function deleteTrack(type, filename, event) {
            event.stopPropagation();
            if (confirm(`¿Estás seguro de que quieres eliminar "${filename}"?`)) {
                try {
                    const response = await fetch(`/delete/${type}/${encodeURIComponent(filename)}`, { method: 'POST' });
                    const result = await response.json();
                    if (result.success) {
                        fetchAndUpdateAllTracks(); // Refresca la lista
                    } else { alert('Error al eliminar: ' + result.error); }
                } catch (error) { alert('Error de red: ' + error.message); }
            }
        }
        
        // Reemplaza el setInterval anterior por este bloque
        let isUserInteracting = false;
        let interactionTimeout = null;
        
        function markInteraction() {
            isUserInteracting = true;
            clearTimeout(interactionTimeout);
            // si no hay interacción en 12s, consideramos que dejó de interactuar
            interactionTimeout = setTimeout(() => { isUserInteracting = false; }, 12000);
        }

        // detectar interacción en controles / click (pero ignorar clicks en botones de eliminar/descarga para no bloquearho innecesariamente)
        document.addEventListener('input', markInteraction, true);
        document.addEventListener('mousedown', (e) => {
            if (e.target.classList && e.target.classList.contains('delete-btn')) return;
            markInteraction();
        }, true);
        document.addEventListener('touchstart', markInteraction, true);

        // función robusta que detecta si hay algún audio reproduciéndose
        function isAnyAudioPlaying() {
            const audios = document.querySelectorAll('audio');
            for (const a of audios) {
                // algunos navegadores usan .paused, otros pueden tener .ended
                if (!a.paused && !a.ended && a.currentTime > 0) return true;
            }
            return false;
        }
        
        // comprobación periódica: si NO hay audio reproduciéndose ni interacción, actualizamos
        setInterval(() => {
            if (!isAnyAudioPlaying() && !isUserInteracting) {
                // llama a la función correspondiente según la página
                if (typeof updateTrackLists === 'function') updateTrackLists();
                if (typeof fetchAndUpdateAllTracks === 'function') fetchAndUpdateAllTracks();
            } else {
                // opcional para debug
                // console.log('Refresco pausado — audioPlaying:', isAnyAudioPlaying(), 'interacting:', isUserInteracting);
            }
        }, 8000);

        document.addEventListener('DOMContentLoaded', fetchAndUpdateAllTracks);
        </script>
        <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>

